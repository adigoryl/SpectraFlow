<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>plots.plots &#8212; SpectraFlow Feb 2024 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=61cd365c" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=a448a05f"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for plots.plots</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">import</span> <span class="nn">plotly.offline</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">from</span> <span class="nn">plotly.subplots</span> <span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">import</span> <span class="nn">plotly</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">import</span> <span class="nn">copy</span>


<div class="viewcode-block" id="extract_values">
<a class="viewcode-back" href="../../plots.html#plots.plots.extract_values">[docs]</a>
<span class="k">def</span> <span class="nf">extract_values</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">values</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;Standard deviation values:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">mean_values</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;Standard deviation values:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;Mean values:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">mean_values_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mean_values</span><span class="p">)</span>
    <span class="n">std_dev_values_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">values</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mean_values_dict</span><span class="p">[</span><span class="s1">&#39;val_f1_shallow&#39;</span><span class="p">],</span> <span class="n">mean_values_dict</span><span class="p">[</span><span class="s1">&#39;val_auc_shallow&#39;</span><span class="p">],</span> <span class="n">std_dev_values_dict</span><span class="p">[</span>
        <span class="s1">&#39;val_f1_shallow&#39;</span><span class="p">],</span> <span class="n">std_dev_values_dict</span><span class="p">[</span><span class="s1">&#39;val_auc_shallow&#39;</span><span class="p">]</span></div>



<div class="viewcode-block" id="sort_paths_by_epoch">
<a class="viewcode-back" href="../../plots.html#plots.plots.sort_paths_by_epoch">[docs]</a>
<span class="k">def</span> <span class="nf">sort_paths_by_epoch</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">extract_epoch_number</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;epoch(\d+)&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">match</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">extract_epoch_number</span><span class="p">)</span></div>



<div class="viewcode-block" id="jaccard_similarity">
<a class="viewcode-back" href="../../plots.html#plots.plots.jaccard_similarity">[docs]</a>
<span class="k">def</span> <span class="nf">jaccard_similarity</span><span class="p">(</span><span class="n">list1</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">list2</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Jaccard Similarity between two lists.</span>

<span class="sd">    The Jaccard similarity coefficient measures the size of the intersection divided by the size of the union of two sets.</span>
<span class="sd">    The resulting number is a scalar value representing the overall similarity (or stability) of the feature selection</span>
<span class="sd">    reflected by the different rankings. Note that the Jaccard similarity ranges from 0 to 1, where 1 signifies that</span>
<span class="sd">    the rankings are identical, and 0 signifies that the rankings do not share any features.</span>

<span class="sd">    Args:</span>
<span class="sd">        list1 (List[str]): First list of features</span>
<span class="sd">        list2 (List[str]): Second list of features</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Jaccard similarity between the two lists</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">intersection</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list1</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">list2</span><span class="p">)))</span>
    <span class="n">union</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">list2</span><span class="p">))</span> <span class="o">-</span> <span class="n">intersection</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span> <span class="o">/</span> <span class="n">union</span></div>



<div class="viewcode-block" id="average_jaccard_similarity">
<a class="viewcode-back" href="../../plots.html#plots.plots.average_jaccard_similarity">[docs]</a>
<span class="k">def</span> <span class="nf">average_jaccard_similarity</span><span class="p">(</span><span class="n">rankings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the average Jaccard similarity and standard deviation for a list of rankings</span>

<span class="sd">    Args:</span>
<span class="sd">        rankings (List[List[str]]): List of rankings, where each ranking is a list of features</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[float, float]: Average Jaccard similarity and standard deviation across all pairs of rankings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jaccard_similarities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rankings</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rankings</span><span class="p">)):</span>
            <span class="n">similarity</span> <span class="o">=</span> <span class="n">jaccard_similarity</span><span class="p">(</span><span class="n">rankings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rankings</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">jaccard_similarities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">similarity</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jaccard_similarities</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">jaccard_similarities</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span></div>


<span class="c1"># ----------------------------------------------------------</span>
<span class="c1"># PLOT THE SCORE AND SIMILARTY PER EPOCH, OR X EPOCH PER FEATURE SELECTED</span>
<span class="c1"># ----------------------</span>
<span class="c1"># a = &quot;/Users/aw678/PycharmProjects/sequential_attention/sequential_attention/experiments/Test&quot;</span>
<span class="c1"># path_list = glob.glob(a + &quot;/*/*/*/*/*/results_summary.txt&quot;)</span>
<span class="c1"># path_list = path_list[0:6]</span>
<span class="c1"># sorted_paths = sort_paths_by_epoch(path_list)</span>
<span class="c1">#</span>
<span class="c1"># result_lists = {</span>
<span class="c1">#     &#39;mean_f1&#39;: [],</span>
<span class="c1">#     &#39;mean_auc&#39;: [],</span>
<span class="c1">#     &#39;std_f1&#39;: [],</span>
<span class="c1">#     &#39;std_auc&#39;: [],</span>
<span class="c1">#     &#39;avg_similarity&#39;: [],</span>
<span class="c1">#     &#39;std_similarity&#39;: [],</span>
<span class="c1">#     &#39;epoch_per_selected_feature&#39;: []</span>
<span class="c1"># }</span>
<span class="c1">#</span>
<span class="c1"># for path in sorted_paths:</span>
<span class="c1">#     path_components = path.split(os.sep)</span>
<span class="c1">#</span>
<span class="c1">#     mean_f1, mean_auc, std_f1, std_auc = extract_values(path)</span>
<span class="c1">#     result_lists[&#39;mean_f1&#39;].append(mean_f1)</span>
<span class="c1">#     result_lists[&#39;mean_auc&#39;].append(mean_auc)</span>
<span class="c1">#     result_lists[&#39;std_f1&#39;].append(std_f1)</span>
<span class="c1">#     result_lists[&#39;std_auc&#39;].append(std_auc)</span>
<span class="c1">#</span>
<span class="c1">#     # print(&quot;{}/{}/{}: mean f1 {} mean auc {} | std f1 {} std auc {}&quot;.format(path_components[8], path_components[10],</span>
<span class="c1">#     #                                                      path_components[11], a, b, c, d))</span>
<span class="c1">#</span>
<span class="c1">#     # Get the directory part of the old path</span>
<span class="c1">#     directory = os.path.dirname(path)</span>
<span class="c1">#</span>
<span class="c1">#     # Define the new file name</span>
<span class="c1">#     new_file_name = &quot;selected_feature_indicies.backup&quot;</span>
<span class="c1">#</span>
<span class="c1">#     # Join the directory with the new file name</span>
<span class="c1">#     rankings_path = os.path.join(directory, new_file_name)</span>
<span class="c1">#</span>
<span class="c1">#     with open(rankings_path, &#39;rb&#39;) as f:</span>
<span class="c1">#         rankings = pickle.load(f)</span>
<span class="c1">#</span>
<span class="c1">#     avg_similarity, std_dev = average_jaccard_similarity(rankings)</span>
<span class="c1">#     result_lists[&#39;avg_similarity&#39;].append(avg_similarity)</span>
<span class="c1">#     result_lists[&#39;std_similarity&#39;].append(std_dev)</span>
<span class="c1">#</span>
<span class="c1">#     epoch = int(re.findall(r&#39;\d+&#39;, path_components[11])[0])</span>
<span class="c1">#     num_of_features_to_select = 50</span>
<span class="c1">#     result_lists[&#39;epoch_per_selected_feature&#39;].append(epoch // num_of_features_to_select)</span>
<span class="c1">#</span>
<span class="c1"># # # Now you have your separate lists:</span>
<span class="c1"># # print(result_lists[&#39;mean_f1&#39;])</span>
<span class="c1"># # print(result_lists[&#39;mean_auc&#39;])</span>
<span class="c1"># # print(result_lists[&#39;std_f1&#39;])</span>
<span class="c1"># # print(result_lists[&#39;std_auc&#39;])</span>
<span class="c1"># # print(result_lists[&#39;avg_similarity&#39;])</span>
<span class="c1"># # print(result_lists[&#39;std_similarity&#39;])</span>
<span class="c1"># # print(result_lists[&#39;epoch_per_selected_feature&#39;])</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># def add_trace_with_std(fig, df, x, y, y_std, name, color, yaxis=&#39;y&#39;):</span>
<span class="c1">#     lighter_color = [min(c + 50, 255) for c in color]</span>
<span class="c1">#     darker_color = [max(c - 50, 0) for c in color]</span>
<span class="c1">#</span>
<span class="c1">#     fig.add_trace(go.Scatter(x=df[x], y=df[y] + df[y_std], mode=&#39;lines&#39;,</span>
<span class="c1">#                              line=dict(color=f&#39;rgba({lighter_color[0]}, {lighter_color[1]}, {lighter_color[2]}, 0.3)&#39;),</span>
<span class="c1">#                              showlegend=False, yaxis=yaxis, name=name))</span>
<span class="c1">#</span>
<span class="c1">#     fig.add_trace(go.Scatter(x=df[x], y=df[y] - df[y_std], mode=&#39;lines&#39;,</span>
<span class="c1">#                              line=dict(color=f&#39;rgba({lighter_color[0]}, {lighter_color[1]}, {lighter_color[2]}, 0.3)&#39;),</span>
<span class="c1">#                              fill=&#39;tonexty&#39;, showlegend=False, yaxis=yaxis, name=name))</span>
<span class="c1">#</span>
<span class="c1">#     fig.add_trace(go.Scatter(x=df[x], y=df[y], mode=&#39;lines+markers&#39;,</span>
<span class="c1">#                              line=dict(color=f&#39;rgb({darker_color[0]}, {darker_color[1]}, {darker_color[2]})&#39;),</span>
<span class="c1">#                              name=name, yaxis=yaxis))</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># df = pd.DataFrame(result_lists)</span>
<span class="c1">#</span>
<span class="c1"># fig = go.Figure()</span>
<span class="c1">#</span>
<span class="c1"># add_trace_with_std(fig, df, &#39;epoch_per_selected_feature&#39;, &#39;mean_auc&#39;, &#39;std_auc&#39;, &#39;Mean AUC&#39;, [31, 119, 180])</span>
<span class="c1"># add_trace_with_std(fig, df, &#39;epoch_per_selected_feature&#39;, &#39;avg_similarity&#39;, &#39;std_similarity&#39;, &#39;Avg Similarity&#39;, [255, 127, 14], &#39;y2&#39;)</span>
<span class="c1">#</span>
<span class="c1"># fig.update_layout(</span>
<span class="c1">#     xaxis=dict(title=&#39;Epoch per selected feature&#39;),</span>
<span class="c1">#     yaxis=dict(title=&#39;Mean AUC&#39;),</span>
<span class="c1">#     yaxis2=dict(</span>
<span class="c1">#         title=&#39;Avg Similarity&#39;,</span>
<span class="c1">#         overlaying=&#39;y&#39;,</span>
<span class="c1">#         side=&#39;right&#39;</span>
<span class="c1">#     ),</span>
<span class="c1">#     template=&#39;plotly_white&#39;</span>
<span class="c1"># )</span>
<span class="c1">#</span>
<span class="c1"># plotly.offline.plot(fig, filename=&#39;plot.html&#39;)</span>


<div class="viewcode-block" id="load_pickle_file">
<a class="viewcode-back" href="../../plots.html#plots.plots.load_pickle_file">[docs]</a>
<span class="k">def</span> <span class="nf">load_pickle_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_csv_file">
<a class="viewcode-back" href="../../plots.html#plots.plots.load_csv_file">[docs]</a>
<span class="k">def</span> <span class="nf">load_csv_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span></div>



<div class="viewcode-block" id="ranking_stats_to_txt">
<a class="viewcode-back" href="../../plots.html#plots.plots.ranking_stats_to_txt">[docs]</a>
<span class="k">def</span> <span class="nf">ranking_stats_to_txt</span><span class="p">(</span><span class="n">top_features</span><span class="p">,</span> <span class="n">bins_to_names</span><span class="p">,</span> <span class="n">save_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a DataFrame: add binned metabolites, binned metabolite range, sort by mean, and rename columns.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    top_features (pandas.DataFrame): Input DataFrame.</span>
<span class="sd">    bins_to_names (dict): Dictionary for mapping bin numbers to feature names.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pandas.DataFrame: The processed DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">top_features</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">feature_range</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">top_fs_index</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">bins_to_names</span><span class="p">[</span><span class="n">top_fs_index</span><span class="p">]</span>
        <span class="n">feature_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="n">feature_range</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">4</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="mi">4</span><span class="p">)))</span>

    <span class="n">a</span><span class="p">[</span><span class="s1">&#39;binned_metabolites&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_names</span>
    <span class="n">a</span><span class="p">[</span><span class="s1">&#39;binned_metabolite_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_range</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>

    <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;bin_number&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="s2">&quot;mean_rank_position_across_samples&quot;</span><span class="p">,</span>
        <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="s2">&quot;Frequency_count_across_sample_rankings&quot;</span>  <span class="c1"># fixed a typo in your code</span>
    <span class="p">}</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rename_dict</span><span class="p">)</span>

    <span class="n">a</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s1">&#39;/selected_metabolite_ranges.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span></div>



<div class="viewcode-block" id="get_index_positions">
<a class="viewcode-back" href="../../plots.html#plots.plots.get_index_positions">[docs]</a>
<span class="k">def</span> <span class="nf">get_index_positions</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">index_positions</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sublist</span><span class="p">):</span>
            <span class="n">index_positions</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">index_positions</span></div>



<div class="viewcode-block" id="create_stats_df">
<a class="viewcode-back" href="../../plots.html#plots.plots.create_stats_df">[docs]</a>
<span class="k">def</span> <span class="nf">create_stats_df</span><span class="p">(</span><span class="n">unique_features</span><span class="p">,</span> <span class="n">index_positions</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">unique_features</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;Q1&#39;</span><span class="p">,</span> <span class="s1">&#39;Q3&#39;</span><span class="p">,</span> <span class="s1">&#39;frequency&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">unique_features</span><span class="p">:</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">index_positions</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feature</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feature</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feature</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feature</span><span class="p">,</span> <span class="s1">&#39;Q1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feature</span><span class="p">,</span> <span class="s1">&#39;Q3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feature</span><span class="p">,</span> <span class="s1">&#39;frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<span class="c1"># ----------------------------------------</span>
<span class="c1"># PLOT THE PREDICTION ACCURACY AND SIMILARITY FOR RECURSIVE FEATURE ELIMINATION AFTER SEQUENTIAL ATTENTION FEATURE SELECTION</span>
<span class="c1"># ---------------------------------</span>
<div class="viewcode-block" id="plot_pred_acc_multimetric_RFE">
<a class="viewcode-back" href="../../plots.html#plots.plots.plot_pred_acc_multimetric_RFE">[docs]</a>
<span class="k">def</span> <span class="nf">plot_pred_acc_multimetric_RFE</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ordered_ranking</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">auto_open</span><span class="p">,</span> <span class="n">metric_dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rfe_val_auc_shallow&quot;</span><span class="p">:</span> <span class="s2">&quot;AUC Accuracy&quot;</span><span class="p">}):</span>

    <span class="c1"># Create stats_df for each metric</span>
    <span class="n">stats_dfs</span> <span class="o">=</span> <span class="p">{</span><span class="n">metric</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;RFE_step&#39;</span><span class="p">)[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metric_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

    <span class="n">sins_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ordered_ranking</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">ordered_ranking</span><span class="p">]</span>
        <span class="n">avg_similarity</span><span class="p">,</span> <span class="n">std_dev</span> <span class="o">=</span> <span class="n">average_jaccard_similarity</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">sins_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;avg_similarity&quot;</span><span class="p">:</span> <span class="n">avg_similarity</span><span class="p">,</span>
            <span class="s2">&quot;std_dev&quot;</span><span class="p">:</span> <span class="n">std_dev</span><span class="p">,</span>
            <span class="s2">&quot;RFE_step&quot;</span><span class="p">:</span> <span class="n">i</span>
        <span class="p">})</span>

    <span class="n">sims_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sins_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_trace</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y_upper</span><span class="p">,</span> <span class="n">y_lower</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">fillcolor</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">),</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_upper</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tonexty&#39;</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="n">fillcolor</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_lower</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tonexty&#39;</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="n">fillcolor</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="c1"># Create a new figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;rgba(0, 0, 255, 1)&#39;</span><span class="p">,</span>   <span class="c1"># Blue</span>
        <span class="s1">&#39;rgba(0, 128, 0, 1)&#39;</span><span class="p">,</span>  <span class="c1"># Green</span>
        <span class="s1">&#39;rgba(128, 0, 128, 1)&#39;</span><span class="p">,</span><span class="c1"># Purple</span>
        <span class="s1">&#39;rgba(255, 165, 0, 1)&#39;</span><span class="p">,</span><span class="c1"># Orange</span>
        <span class="s1">&#39;rgba(255, 0, 0, 1)&#39;</span>   <span class="c1"># Red</span>
    <span class="p">]</span>

    <span class="c1"># Loop through each metric and add to the plot</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metric_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">idx</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span>
        <span class="n">fillcolor</span> <span class="o">=</span> <span class="n">color</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;, 1)&quot;</span><span class="p">,</span> <span class="s2">&quot;, 0.2)&quot;</span><span class="p">)</span>

        <span class="n">data_to_plot</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">stats_dfs</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">stats_dfs</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span>
            <span class="s1">&#39;y_upper&#39;</span><span class="p">:</span> <span class="n">stats_dfs</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">stats_dfs</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;std&#39;</span><span class="p">],</span>
            <span class="s1">&#39;y_lower&#39;</span><span class="p">:</span> <span class="n">stats_dfs</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">stats_dfs</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="s1">&#39;std&#39;</span><span class="p">],</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Mean </span><span class="si">{</span><span class="n">metric_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span>
            <span class="s1">&#39;fillcolor&#39;</span><span class="p">:</span> <span class="n">fillcolor</span><span class="p">,</span>
            <span class="s1">&#39;yaxis&#39;</span><span class="p">:</span> <span class="s1">&#39;y1&#39;</span>
        <span class="p">}</span>

        <span class="n">add_trace</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="o">**</span><span class="n">data_to_plot</span><span class="p">)</span>

    <span class="c1"># Adding ranking similarity</span>
    <span class="n">add_trace</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">sims_df</span><span class="p">[</span><span class="s1">&#39;RFE_step&#39;</span><span class="p">],</span> <span class="n">sims_df</span><span class="p">[</span><span class="s1">&#39;avg_similarity&#39;</span><span class="p">],</span> <span class="n">sims_df</span><span class="p">[</span><span class="s1">&#39;avg_similarity&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">sims_df</span><span class="p">[</span><span class="s1">&#39;std_dev&#39;</span><span class="p">],</span>
              <span class="n">sims_df</span><span class="p">[</span><span class="s1">&#39;avg_similarity&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">sims_df</span><span class="p">[</span><span class="s1">&#39;std_dev&#39;</span><span class="p">],</span> <span class="s1">&#39;Mean Ranking Similarity&#39;</span><span class="p">,</span> <span class="s1">&#39;rgba(255, 0, 0, 1)&#39;</span><span class="p">,</span> <span class="s1">&#39;rgba(255, 0, 0, 0.2)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;y2&#39;</span><span class="p">)</span>

    <span class="c1"># Update layout to include a secondary Y-axis</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Prediction accuracy and ranking similarity across samples.&#39;</span><span class="p">,</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Number of top Metabolic Features evaluated&#39;</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Prediction Accuracy&#39;</span><span class="p">,</span>
        <span class="n">yaxis2</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Mean Ranking Similarity&#39;</span><span class="p">,</span> <span class="n">overlaying</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">),</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/acc_simi_multiple_metrics.html&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
    <span class="n">plotly</span><span class="o">.</span><span class="n">offline</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">auto_open</span><span class="o">=</span><span class="n">auto_open</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_pred_acc_and_sim_for_RFE">
<a class="viewcode-back" href="../../plots.html#plots.plots.plot_pred_acc_and_sim_for_RFE">[docs]</a>
<span class="k">def</span> <span class="nf">plot_pred_acc_and_sim_for_RFE</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ordered_ranking</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">auto_open</span><span class="p">,</span> <span class="n">metric_dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rfe_val_auc_shallow&quot;</span><span class="p">:</span> <span class="s2">&quot;AUC Accuracy&quot;</span><span class="p">}):</span>

    <span class="n">metric</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">stats_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;RFE_step&#39;</span><span class="p">)[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">])</span>

    <span class="n">sins_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ordered_ranking</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">ordered_ranking</span><span class="p">]</span>
        <span class="n">avg_similarity</span><span class="p">,</span> <span class="n">std_dev</span> <span class="o">=</span> <span class="n">average_jaccard_similarity</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="n">sins_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;avg_similarity&quot;</span><span class="p">:</span> <span class="n">avg_similarity</span><span class="p">,</span>
            <span class="s2">&quot;std_dev&quot;</span><span class="p">:</span> <span class="n">std_dev</span><span class="p">,</span>
            <span class="s2">&quot;RFE_step&quot;</span><span class="p">:</span> <span class="n">i</span>
        <span class="p">})</span>

    <span class="n">sims_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sins_list</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">add_trace</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y_upper</span><span class="p">,</span> <span class="n">y_lower</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">fillcolor</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">),</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_upper</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tonexty&#39;</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="n">fillcolor</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">,</span><span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_lower</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tonexty&#39;</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="n">fillcolor</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">,</span><span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>


    <span class="c1"># Create a new figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

    <span class="c1"># List of data to add to the plot</span>
    <span class="n">data_to_plot</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">stats_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span>
            <span class="s1">&#39;y_upper&#39;</span><span class="p">:</span> <span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span>
            <span class="s1">&#39;y_lower&#39;</span><span class="p">:</span> <span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Mean Test Accuracy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fillcolor&#39;</span><span class="p">:</span> <span class="s1">&#39;rgba(0, 0, 255, 0.2)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;yaxis&#39;</span><span class="p">:</span> <span class="s1">&#39;y1&#39;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">sims_df</span><span class="p">[</span><span class="s1">&#39;RFE_step&#39;</span><span class="p">],</span>
            <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">sims_df</span><span class="p">[</span><span class="s1">&#39;avg_similarity&#39;</span><span class="p">],</span>
            <span class="s1">&#39;y_upper&#39;</span><span class="p">:</span> <span class="n">sims_df</span><span class="p">[</span><span class="s1">&#39;avg_similarity&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">sims_df</span><span class="p">[</span><span class="s1">&#39;std_dev&#39;</span><span class="p">],</span>
            <span class="s1">&#39;y_lower&#39;</span><span class="p">:</span> <span class="n">sims_df</span><span class="p">[</span><span class="s1">&#39;avg_similarity&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">sims_df</span><span class="p">[</span><span class="s1">&#39;std_dev&#39;</span><span class="p">],</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Mean Ranking Similarity&#39;</span><span class="p">,</span>
            <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fillcolor&#39;</span><span class="p">:</span> <span class="s1">&#39;rgba(255, 0, 0, 0.2)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;yaxis&#39;</span><span class="p">:</span> <span class="s1">&#39;y2&#39;</span>
        <span class="p">}</span>
    <span class="p">]</span>

    <span class="c1"># Add data to the plot</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_to_plot</span><span class="p">:</span>
        <span class="n">add_trace</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Update layout to include a secondary Y-axis</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Prediction accuracy and ranking similarity across samples.&#39;</span><span class="p">,</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Number of top Metabolic Features evaluated&#39;</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="n">metric_dict</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span>
        <span class="n">yaxis2</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Mean Ranking Similarity&#39;</span><span class="p">,</span> <span class="n">overlaying</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">),</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/acc_simi__</span><span class="si">{}</span><span class="s2">.html&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
    <span class="n">plotly</span><span class="o">.</span><span class="n">offline</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">auto_open</span><span class="o">=</span><span class="n">auto_open</span><span class="p">)</span></div>


<span class="c1"># --------------------------------------------------------</span>
<span class="c1"># FEATURE RANKING PLOT</span>
<span class="c1"># ---------</span>
<div class="viewcode-block" id="feature_ranking_plot">
<a class="viewcode-back" href="../../plots.html#plots.plots.feature_ranking_plot">[docs]</a>
<span class="k">def</span> <span class="nf">feature_ranking_plot</span><span class="p">(</span><span class="n">top_features</span><span class="p">,</span> <span class="n">index_positions</span><span class="p">,</span> <span class="n">bins_to_names</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">auto_open</span><span class="p">):</span>

    <span class="n">top_features</span> <span class="o">=</span> <span class="n">top_features</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Create a horizontal box plot</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">top_features</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="c1"># Append the frequency to the feature name</span>
        <span class="n">ppm_range</span> <span class="o">=</span> <span class="n">bins_to_names</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ppm_range</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">feature_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">ppm (frq</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ppm_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ppm_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">3</span><span class="p">),</span> <span class="n">top_features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feature</span><span class="p">,</span> <span class="s1">&#39;frequency&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">feature_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (frq</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ppm_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">top_features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feature</span><span class="p">,</span> <span class="s1">&#39;frequency&#39;</span><span class="p">])</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">index_positions</span><span class="p">[</span><span class="n">feature</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">feature_name</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">marker_color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">))</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Ranking Position&quot;</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;Metabolic Feature&quot;</span><span class="p">,</span>
        <span class="c1"># boxmode=&#39;group&#39;,  # group together boxes of the different traces for each value of x</span>
        <span class="c1"># autosize=False,</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span>

    <span class="p">)</span>

    <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/feature_ranking.html&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
    <span class="n">plotly</span><span class="o">.</span><span class="n">offline</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">auto_open</span><span class="o">=</span><span class="n">auto_open</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span></div>


<span class="c1"># -------------------------------------</span>
<span class="c1"># PPM plot median and all samples</span>
<span class="c1"># --------------------------</span>
<div class="viewcode-block" id="plot_ppm_with_selection">
<a class="viewcode-back" href="../../plots.html#plots.plots.plot_ppm_with_selection">[docs]</a>
<span class="k">def</span> <span class="nf">plot_ppm_with_selection</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">pca_ds</span><span class="p">,</span> <span class="n">top_features</span><span class="p">,</span> <span class="n">bins_to_names</span><span class="p">,</span> <span class="n">ppm_chart_title</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">auto_open</span><span class="p">,</span> <span class="n">plot_median</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">add_trace</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">class_data</span><span class="p">,</span> <span class="n">ppm_float</span><span class="p">,</span> <span class="n">class_value</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">class_colour</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legendgroup</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ppm_float</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">class_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">class_colour</span><span class="p">),</span> <span class="n">legendgroup</span><span class="o">=</span><span class="n">legendgroup</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="n">showlegend</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_vrect</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_vrect</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="n">min_val</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="n">max_val</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>

    <span class="n">vaso_class</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.0</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">}</span>
    <span class="n">vaso_class1</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.0</span><span class="p">:</span> <span class="s2">&quot;Vasoplegia Positive (plot 1)&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">:</span> <span class="s2">&quot;Vasoplegia Negative (plot 1)&quot;</span><span class="p">}</span>
    <span class="n">vaso_class2</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.0</span><span class="p">:</span> <span class="s2">&quot;Vasoplegia Positive (plot 2)&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">:</span> <span class="s2">&quot;Vasoplegia Negative (plot 2)&quot;</span><span class="p">}</span>
    <span class="n">vaso_class3</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.0</span><span class="p">:</span> <span class="s2">&quot;Vasoplegia Positive (plot 3)&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">:</span> <span class="s2">&quot;Vasoplegia Negative (plot 3)&quot;</span><span class="p">}</span>

    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Fit and transform the complete dataset</span>
    <span class="n">ds_scaled</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="n">ds_scaled</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ds</span><span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">2</span><span class="p">]],</span> <span class="n">ds_scaled</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ppm_float</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shared_xaxes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">median_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">plot_median</span><span class="p">:</span>
        <span class="n">median_prefix</span> <span class="o">=</span> <span class="s2">&quot;Median &quot;</span>
        <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Vasoplegia&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">class_value</span> <span class="ow">in</span> <span class="n">unique_classes</span><span class="p">:</span>
            <span class="n">class_data</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Vasoplegia&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_value</span><span class="p">][</span><span class="n">ds</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
            <span class="n">median_data</span> <span class="o">=</span> <span class="n">class_data</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>  <span class="c1"># Compute median</span>
            <span class="n">add_trace</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">median_data</span><span class="p">,</span> <span class="n">ppm_float</span><span class="p">,</span> <span class="n">class_value</span><span class="p">,</span> <span class="n">vaso_class1</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="n">vaso_class</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legendgroup</span><span class="o">=</span><span class="n">vaso_class1</span><span class="p">[</span><span class="n">class_value</span><span class="p">])</span>  <span class="c1"># No scaling for subplot 1</span>

            <span class="n">class_data_scaled</span> <span class="o">=</span> <span class="n">ds_scaled</span><span class="p">[</span><span class="n">ds_scaled</span><span class="p">[</span><span class="s2">&quot;Vasoplegia&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_value</span><span class="p">][</span><span class="n">ds_scaled</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
            <span class="n">median_data_scaled</span> <span class="o">=</span> <span class="n">class_data_scaled</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>  <span class="c1"># Compute median of scaled data</span>
            <span class="n">add_trace</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">median_data_scaled</span><span class="p">,</span> <span class="n">ppm_float</span><span class="p">,</span> <span class="n">class_value</span><span class="p">,</span> <span class="n">vaso_class2</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="n">vaso_class</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legendgroup</span><span class="o">=</span><span class="n">vaso_class2</span><span class="p">[</span><span class="n">class_value</span><span class="p">])</span>  <span class="c1"># Scaling for subplot 2</span>

            <span class="n">class_data</span> <span class="o">=</span> <span class="n">pca_ds</span><span class="p">[</span><span class="n">pca_ds</span><span class="p">[</span><span class="s2">&quot;Vasoplegia&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_value</span><span class="p">][</span><span class="n">pca_ds</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
            <span class="n">median_pca_data</span> <span class="o">=</span> <span class="n">class_data</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>  <span class="c1"># Compute median of PCA data</span>
            <span class="n">add_trace</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">median_pca_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pca_ds</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))),</span> <span class="n">class_value</span><span class="p">,</span> <span class="n">vaso_class3</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="n">vaso_class</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legendgroup</span><span class="o">=</span><span class="n">vaso_class3</span><span class="p">[</span><span class="n">class_value</span><span class="p">])</span>  <span class="c1"># No scaling for subplot 3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Vasoplegia&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">class_value</span> <span class="ow">in</span> <span class="n">unique_classes</span><span class="p">:</span>
            <span class="n">group_data</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Vasoplegia&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_value</span><span class="p">]</span>
            <span class="n">group_data_scaled</span> <span class="o">=</span> <span class="n">ds_scaled</span><span class="p">[</span><span class="n">ds_scaled</span><span class="p">[</span><span class="s2">&quot;Vasoplegia&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_value</span><span class="p">]</span>
            <span class="n">group_data_pca</span> <span class="o">=</span> <span class="n">pca_ds</span><span class="p">[</span><span class="n">pca_ds</span><span class="p">[</span><span class="s2">&quot;Vasoplegia&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_value</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">row_scaled</span><span class="p">,</span> <span class="n">row_pca</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">group_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">group_data_scaled</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">group_data_pca</span><span class="o">.</span><span class="n">iterrows</span><span class="p">())):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Skip rows that aren&#39;t every 4th row</span>
                    <span class="k">continue</span>

                <span class="n">show_legend</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

                <span class="n">add_trace</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ppm_float</span><span class="p">,</span> <span class="n">class_value</span><span class="p">,</span> <span class="n">vaso_class1</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="n">vaso_class</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="n">show_legend</span><span class="p">,</span> <span class="n">legendgroup</span><span class="o">=</span><span class="n">vaso_class1</span><span class="p">[</span><span class="n">class_value</span><span class="p">])</span>
                <span class="n">add_trace</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">row_scaled</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ppm_float</span><span class="p">,</span> <span class="n">class_value</span><span class="p">,</span> <span class="n">vaso_class2</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="n">vaso_class</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="n">show_legend</span><span class="p">,</span> <span class="n">legendgroup</span><span class="o">=</span><span class="n">vaso_class2</span><span class="p">[</span><span class="n">class_value</span><span class="p">])</span>
                <span class="n">add_trace</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">row_pca</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pca_ds</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))),</span> <span class="n">class_value</span><span class="p">,</span> <span class="n">vaso_class3</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="n">vaso_class</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="n">show_legend</span><span class="p">,</span><span class="n">legendgroup</span><span class="o">=</span><span class="n">vaso_class3</span><span class="p">[</span><span class="n">class_value</span><span class="p">])</span>

    <span class="n">top_features</span> <span class="o">=</span> <span class="n">top_features</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">top_fs_index</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]):</span>
        <span class="n">feature_names</span> <span class="o">=</span> <span class="n">bins_to_names</span><span class="p">[</span><span class="n">top_fs_index</span><span class="p">]</span>
        <span class="n">feature_ppm_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">]</span>
        <span class="n">ppm_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">feature_ppm_values</span><span class="p">)</span>
        <span class="n">ppm_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">feature_ppm_values</span><span class="p">)</span>
        <span class="n">add_vrect</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ppm_min</span><span class="p">,</span> <span class="n">ppm_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">add_vrect</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ppm_min</span><span class="p">,</span> <span class="n">ppm_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">add_vrect</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">top_fs_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">top_fs_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">autorange</span><span class="o">=</span><span class="s2">&quot;reversed&quot;</span><span class="p">,</span> <span class="n">dtick</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">title_text</span><span class="o">=</span><span class="s1">&#39;PPM Range&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">matches</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="n">median_prefix</span> <span class="o">+</span> <span class="s1">&#39;Signal Intensity&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">autorange</span><span class="o">=</span><span class="s2">&quot;reversed&quot;</span><span class="p">,</span> <span class="n">dtick</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">title_text</span><span class="o">=</span><span class="s1">&#39;PPM Range&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">matches</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="n">median_prefix</span> <span class="o">+</span> <span class="s1">&#39;Scaled Signal Intensity&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="n">median_prefix</span> <span class="o">+</span> <span class="s1">&#39;PCA Binned Features&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s1">&#39;PC1 Values&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">xaxis3</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pca_ds</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">title</span><span class="o">=</span><span class="n">ppm_chart_title</span><span class="p">)</span>

    <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_ppm_chart2.html&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">median_prefix</span><span class="p">)</span>
    <span class="n">plotly</span><span class="o">.</span><span class="n">offline</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">auto_open</span><span class="o">=</span><span class="n">auto_open</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_ppm_with_selection_paper_modified">
<a class="viewcode-back" href="../../plots.html#plots.plots.plot_ppm_with_selection_paper_modified">[docs]</a>
<span class="k">def</span> <span class="nf">plot_ppm_with_selection_paper_modified</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">pca_ds</span><span class="p">,</span> <span class="n">top_features</span><span class="p">,</span> <span class="n">bins_to_names</span><span class="p">,</span> <span class="n">ppm_chart_title</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">auto_open</span><span class="p">,</span> <span class="n">plot_median</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">add_trace</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">class_data</span><span class="p">,</span> <span class="n">ppm_float</span><span class="p">,</span> <span class="n">class_value</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">class_colour</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legendgroup</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ppm_float</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">class_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">class_colour</span><span class="p">),</span> <span class="n">legendgroup</span><span class="o">=</span><span class="n">legendgroup</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="n">showlegend</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_vrect</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_vrect</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="n">min_val</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="n">max_val</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>

    <span class="n">vaso_class</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.0</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">}</span>
    <span class="n">vaso_class1</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.0</span><span class="p">:</span> <span class="s2">&quot;Vasoplegia Positive (plot 1)&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">:</span> <span class="s2">&quot;Vasoplegia Negative (plot 1)&quot;</span><span class="p">}</span>
    <span class="n">vaso_class3</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.0</span><span class="p">:</span> <span class="s2">&quot;Vasoplegia Positive (plot 2)&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">:</span> <span class="s2">&quot;Vasoplegia Negative (plot 2)&quot;</span><span class="p">}</span>
    <span class="c1"># vaso_class3 = {0.0: &quot;Vasoplegia Positive (plot 3)&quot;, 1.0: &quot;Vasoplegia Negative (plot 3)&quot;}</span>

    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Fit and transform the complete dataset</span>
    <span class="n">ds_scaled</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="n">ds_scaled</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ds</span><span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">2</span><span class="p">]],</span> <span class="n">ds_scaled</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ppm_float</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shared_xaxes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">median_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">plot_median</span><span class="p">:</span>
        <span class="n">median_prefix</span> <span class="o">=</span> <span class="s2">&quot;Median &quot;</span>
        <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Vasoplegia&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">class_value</span> <span class="ow">in</span> <span class="n">unique_classes</span><span class="p">:</span>
            <span class="n">class_data</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Vasoplegia&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_value</span><span class="p">][</span><span class="n">ds</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
            <span class="n">median_data</span> <span class="o">=</span> <span class="n">class_data</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>  <span class="c1"># Compute median</span>
            <span class="n">add_trace</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">median_data</span><span class="p">,</span> <span class="n">ppm_float</span><span class="p">,</span> <span class="n">class_value</span><span class="p">,</span> <span class="n">vaso_class1</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="n">vaso_class</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legendgroup</span><span class="o">=</span><span class="n">vaso_class1</span><span class="p">[</span><span class="n">class_value</span><span class="p">])</span>  <span class="c1"># No scaling for subplot 1</span>

            <span class="c1"># class_data_scaled = ds_scaled[ds_scaled[&quot;Vasoplegia&quot;] == class_value][ds_scaled.columns[2:]]</span>
            <span class="c1"># median_data_scaled = class_data_scaled.median()  # Compute median of scaled data</span>
            <span class="c1"># add_trace(fig, median_data_scaled, ppm_float, class_value, vaso_class2[class_value], vaso_class[class_value], 2, 1, showlegend=True, legendgroup=vaso_class2[class_value])  # Scaling for subplot 2</span>

            <span class="n">class_data</span> <span class="o">=</span> <span class="n">pca_ds</span><span class="p">[</span><span class="n">pca_ds</span><span class="p">[</span><span class="s2">&quot;Vasoplegia&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_value</span><span class="p">][</span><span class="n">pca_ds</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
            <span class="n">median_pca_data</span> <span class="o">=</span> <span class="n">class_data</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>  <span class="c1"># Compute median of PCA data</span>
            <span class="n">add_trace</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">median_pca_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pca_ds</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))),</span> <span class="n">class_value</span><span class="p">,</span> <span class="n">vaso_class3</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="n">vaso_class</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legendgroup</span><span class="o">=</span><span class="n">vaso_class3</span><span class="p">[</span><span class="n">class_value</span><span class="p">])</span>  <span class="c1"># No scaling for subplot 3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Vasoplegia&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">class_value</span> <span class="ow">in</span> <span class="n">unique_classes</span><span class="p">:</span>
            <span class="n">group_data</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Vasoplegia&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_value</span><span class="p">]</span>
            <span class="n">group_data_scaled</span> <span class="o">=</span> <span class="n">ds_scaled</span><span class="p">[</span><span class="n">ds_scaled</span><span class="p">[</span><span class="s2">&quot;Vasoplegia&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_value</span><span class="p">]</span>
            <span class="n">group_data_pca</span> <span class="o">=</span> <span class="n">pca_ds</span><span class="p">[</span><span class="n">pca_ds</span><span class="p">[</span><span class="s2">&quot;Vasoplegia&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_value</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">row_scaled</span><span class="p">,</span> <span class="n">row_pca</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">group_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">group_data_scaled</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">group_data_pca</span><span class="o">.</span><span class="n">iterrows</span><span class="p">())):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Skip rows that aren&#39;t every 4th row</span>
                    <span class="k">continue</span>

                <span class="n">show_legend</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

                <span class="n">add_trace</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ppm_float</span><span class="p">,</span> <span class="n">class_value</span><span class="p">,</span> <span class="n">vaso_class1</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="n">vaso_class</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="n">show_legend</span><span class="p">,</span> <span class="n">legendgroup</span><span class="o">=</span><span class="n">vaso_class1</span><span class="p">[</span><span class="n">class_value</span><span class="p">])</span>
                <span class="c1"># add_trace(fig, pd.DataFrame(row_scaled[1][2:]).T, ppm_float, class_value, vaso_class2[class_value], vaso_class[class_value], 2, 1, showlegend=show_legend, legendgroup=vaso_class2[class_value])</span>
                <span class="n">add_trace</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">row_pca</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pca_ds</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))),</span> <span class="n">class_value</span><span class="p">,</span> <span class="n">vaso_class3</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="n">vaso_class</span><span class="p">[</span><span class="n">class_value</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="n">show_legend</span><span class="p">,</span><span class="n">legendgroup</span><span class="o">=</span><span class="n">vaso_class3</span><span class="p">[</span><span class="n">class_value</span><span class="p">])</span>

    <span class="n">top_features</span> <span class="o">=</span> <span class="n">top_features</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">top_fs_index</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]):</span>
        <span class="n">feature_names</span> <span class="o">=</span> <span class="n">bins_to_names</span><span class="p">[</span><span class="n">top_fs_index</span><span class="p">]</span>
        <span class="n">feature_ppm_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">]</span>
        <span class="n">ppm_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">feature_ppm_values</span><span class="p">)</span>
        <span class="n">ppm_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">feature_ppm_values</span><span class="p">)</span>
        <span class="n">add_vrect</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ppm_min</span><span class="p">,</span> <span class="n">ppm_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># add_vrect(fig, ppm_min, ppm_max, 2, 1)</span>
        <span class="n">add_vrect</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">top_fs_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">top_fs_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">autorange</span><span class="o">=</span><span class="s2">&quot;reversed&quot;</span><span class="p">,</span> <span class="n">dtick</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">title_text</span><span class="o">=</span><span class="s1">&#39;PPM Range&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">matches</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="n">median_prefix</span> <span class="o">+</span> <span class="s1">&#39;Signal Intensity&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># fig.update_xaxes(autorange=&quot;reversed&quot;, dtick=0.25, title_text=&#39;PPM Range&#39;, row=2, col=1, matches=&#39;x&#39;)</span>
    <span class="c1"># fig.update_yaxes(title_text=median_prefix + &#39;Scaled Signal Intensity&#39;, row=2, col=1)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="n">median_prefix</span> <span class="o">+</span> <span class="s1">&#39;PCA Binned Features&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s1">&#39;PC1 Values&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">xaxis3</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pca_ds</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">title</span><span class="o">=</span><span class="n">ppm_chart_title</span><span class="p">)</span>

    <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_ppm_chart2.html&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">median_prefix</span><span class="p">)</span>
    <span class="n">plotly</span><span class="o">.</span><span class="n">offline</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">auto_open</span><span class="o">=</span><span class="n">auto_open</span><span class="p">)</span></div>



<div class="viewcode-block" id="generate_plots">
<a class="viewcode-back" href="../../plots.html#plots.plots.generate_plots">[docs]</a>
<span class="k">def</span> <span class="nf">generate_plots</span><span class="p">(</span><span class="n">datasets_root</span><span class="p">,</span> <span class="n">denoised_dataset_name</span><span class="p">,</span> <span class="n">computations_root</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="n">auto_open</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">save_path</span> <span class="o">=</span> <span class="n">computations_root</span> <span class="o">+</span> <span class="s2">&quot;/plots&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Dataset with the original ppm</span>
    <span class="n">original_data_df</span> <span class="o">=</span> <span class="n">load_csv_file</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datasets_root</span><span class="p">,</span> <span class="n">denoised_dataset_name</span><span class="p">))</span>

    <span class="c1"># Dataset with transformed ppm ranges (PCA bins)</span>
    <span class="n">pca_binned_data_df</span> <span class="o">=</span> <span class="n">load_csv_file</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datasets_root</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">))</span>

    <span class="c1"># Ordered rankings from samples</span>
    <span class="n">ordered_ranking</span> <span class="o">=</span> <span class="n">load_pickle_file</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/features_in_selection_order.backup&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">computations_root</span><span class="p">))</span>

    <span class="c1"># For some reason, the sequental attention selects the same feature at the beginning of the training</span>
    <span class="c1">#  (perhaps it&#39;s not trained enough when performing first feature selection) -&gt; drop this feature</span>
    <span class="n">ordered_ranking</span> <span class="o">=</span> <span class="p">[</span><span class="n">sublist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">ordered_ranking</span><span class="p">]</span>

    <span class="c1"># Bin indexes to actual ppm ranges</span>
    <span class="k">if</span> <span class="s2">&quot;peak&quot;</span> <span class="ow">in</span> <span class="n">dataset_name</span><span class="p">:</span>
        <span class="n">bins_to_names</span> <span class="o">=</span> <span class="n">load_pickle_file</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">.peak_to_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datasets_root</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">))</span>
    <span class="k">elif</span> <span class="s2">&quot;bin&quot;</span> <span class="ow">in</span> <span class="n">dataset_name</span><span class="p">:</span>
        <span class="n">bins_to_names</span> <span class="o">=</span> <span class="n">load_pickle_file</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">.bins_to_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datasets_root</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="n">original_data_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">bins_to_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">column_names</span><span class="p">)}</span>


    <span class="c1"># Predictions from sample RFE</span>
    <span class="n">rfe_performance_df</span> <span class="o">=</span> <span class="n">load_pickle_file</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/rfe_performance_scores.backup&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">computations_root</span><span class="p">))</span>

    <span class="c1"># Predictions from Leave-one-out RFE (merged rankings based on samples not used for training)</span>
    <span class="n">loo_rfe_eval_df</span> <span class="o">=</span> <span class="n">load_pickle_file</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/loo_rfe_eval.backup&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">computations_root</span><span class="p">))</span>

    <span class="c1"># ------------------------------------</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ordered_ranking</span><span class="p">)</span>
    <span class="n">unique_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">))</span>
    <span class="c1"># Since the rankings are ordered, we can calculate the respective feature positiions across all sample rankings</span>
    <span class="n">index_positions</span> <span class="o">=</span> <span class="n">get_index_positions</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">create_stats_df</span><span class="p">(</span><span class="n">unique_features</span><span class="p">,</span> <span class="n">index_positions</span><span class="p">)</span>
    <span class="c1"># Multiple samples will cause the ranking exceed the selection threshold, thus we shrink based on the frequency cocurrance across all sample rankings</span>
    <span class="n">top_features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ordered_ranking</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">&#39;frequency&#39;</span><span class="p">)</span>

    <span class="c1"># Save the metabolite selection</span>
    <span class="c1"># ranking_stats_to_txt(top_features, bins_to_names, save_path)</span>

    <span class="c1"># # Plots the selected features on original dataset, scaled and PCA binned.</span>
    <span class="c1"># plot_ppm_with_selection(original_data_df, pca_binned_data_df, top_features, bins_to_names, &quot;&quot;, save_path=save_path, auto_open=auto_open, plot_median=False)</span>
    <span class="n">plot_ppm_with_selection_paper_modified</span><span class="p">(</span><span class="n">original_data_df</span><span class="p">,</span> <span class="n">pca_binned_data_df</span><span class="p">,</span> <span class="n">top_features</span><span class="p">,</span> <span class="n">bins_to_names</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="n">save_path</span><span class="p">,</span> <span class="n">auto_open</span><span class="o">=</span><span class="n">auto_open</span><span class="p">,</span> <span class="n">plot_median</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># Plots the feature selection statistics across all samples (interquartile ranges)</span>
    <span class="c1"># feature_ranking_plot(top_features, index_positions, bins_to_names, save_path=save_path, auto_open=auto_open)</span>

    <span class="c1"># # AUC</span>
    <span class="c1"># plot_pred_acc_and_sim_for_RFE(df=rfe_performance_df, ordered_ranking=ordered_ranking, save_path=save_path, auto_open=auto_open, metric_dict={&quot;rfe_val_auc_shallow&quot;: &quot;AUC Accuracy&quot;})</span>
    <span class="c1">#</span>
    <span class="c1"># # F1</span>
    <span class="c1"># plot_pred_acc_and_sim_for_RFE(df=rfe_performance_df, ordered_ranking=ordered_ranking, save_path=save_path, auto_open=auto_open, metric_dict={&quot;rfe_val_f1_shallow&quot;: &quot;F1 Accuracy&quot;})</span>
    <span class="c1">#</span>
    <span class="c1"># plot_pred_acc_multimetric_RFE(</span>
    <span class="c1">#     df=rfe_performance_df,</span>
    <span class="c1">#     ordered_ranking=ordered_ranking,</span>
    <span class="c1">#     save_path=save_path,</span>
    <span class="c1">#     auto_open=auto_open,</span>
    <span class="c1">#     metric_dict={</span>
    <span class="c1">#         # &#39;rfe_val_f1_shallow&#39;: &#39;F1&#39;,</span>
    <span class="c1">#         # &#39;rfe_val_loss_shallow&#39;: &#39;Loss&#39;,</span>
    <span class="c1">#         # &#39;rfe_val_auc_shallow&#39;: &#39;ROC AUC&#39;,</span>
    <span class="c1">#         &#39;rfe_val_positive_precision_shallow&#39;: &#39;Pos Precision&#39;,</span>
    <span class="c1">#         &#39;rfe_val_positive_recall_shallow&#39;: &#39;Pos Recall&#39;,</span>
    <span class="c1">#         &#39;rfe_val_negative_precision_shallow&#39;: &#39;Neg Precision&#39;,</span>
    <span class="c1">#         &#39;rfe_val_negative_recall_shallow&#39;: &#39;Neg Recall&#39;</span>
    <span class="c1">#     }</span>
    <span class="c1"># )</span>
    <span class="c1">#</span>
    <span class="c1"># #</span>
    <span class="c1"># # # AUC LOO</span>
    <span class="c1"># plot_pred_acc_and_sim_for_RFE(df=loo_rfe_eval_df, ordered_ranking=ordered_ranking, save_path=save_path, auto_open=auto_open, metric_dict={&quot;roc_auc&quot;: &quot;AUC Accuracy&quot;})</span>
    <span class="c1"># #</span>
    <span class="c1"># # # F1 LOO</span>
    <span class="c1"># plot_pred_acc_and_sim_for_RFE(df=loo_rfe_eval_df, ordered_ranking=ordered_ranking, save_path=save_path, auto_open=auto_open, metric_dict={&quot;f1&quot;: &quot;F1 Accuracy&quot;})</span>
    <span class="c1">#</span>
    <span class="c1"># plot_pred_acc_multimetric_RFE(</span>
    <span class="c1">#     df=loo_rfe_eval_df,</span>
    <span class="c1">#     ordered_ranking=ordered_ranking,</span>
    <span class="c1">#     save_path=save_path,</span>
    <span class="c1">#     auto_open=auto_open,</span>
    <span class="c1">#     metric_dict={</span>
    <span class="c1">#         # &#39;f1&#39;: &#39;F1&#39;,</span>
    <span class="c1">#         # &#39;roc_auc&#39;: &#39;ROC AUC&#39;,</span>
    <span class="c1">#         &#39;positive_precision&#39;: &#39;Pos Precision&#39;,</span>
    <span class="c1">#         &#39;positive_recall&#39;: &#39;Pos Recall&#39;,</span>
    <span class="c1">#         &#39;negative_precision&#39;: &#39;Neg Precision&#39;,</span>
    <span class="c1">#         &#39;negative_recall&#39;: &#39;Neg Recall&#39;</span>
    <span class="c1">#     }</span>
    <span class="c1"># )</span>

    <span class="k">return</span> <span class="kc">None</span></div>



<span class="c1"># generate_plots(</span>
<span class="c1">#     datasets_root=&quot;/Users/aw678/PycharmProjects/sequential_attention/sequential_attention/experiments/datasets/vasoplegia/different_wavelets&quot;,</span>
<span class="c1">#     denoised_dataset_name=&quot;cpmg_db4&quot;,</span>
<span class="c1">#     computations_root=&quot;/Users/aw678/PycharmProjects/sequential_attention/sequential_attention/experiments/LOO_RFE_seq_attention_no_pre_wavelets_test/10_FOLDS_5_REPS/2023-07-26_16:12/cpmg_db4__pca_reduction__bin005_overlap0025/epoch500/no_scaler&quot;,</span>
<span class="c1">#     dataset_name=&quot;cpmg_db4__pca_reduction__bin005_overlap0025&quot;,</span>
<span class="c1">#     auto_open=True</span>
<span class="c1"># )</span>

<span class="c1"># # ----------------------------------</span>
<span class="c1"># # Example for targeted dataset (commet out one the ppm plot and ranking_stats_to_txt)</span>
<span class="c1"># generate_plots(</span>
<span class="c1">#     datasets_root=&quot;/Users/aw678/PycharmProjects/sequential_attention/sequential_attention/experiments/datasets/vasoplegia/&quot;,</span>
<span class="c1">#     denoised_dataset_name=&quot;CPMG_targeted_clean&quot;,</span>
<span class="c1">#     computations_root=&quot;/Users/aw678/PycharmProjects/sequential_attention/sequential_attention/experiments/LOO_RFE_seq_attention_no_pre_wavelets_test/10_FOLDS_5_REPS/2023-08-04_16:39/CPMG_targeted_clean/epoch100/auto_scaler&quot;,</span>
<span class="c1">#     dataset_name=&quot;CPMG_targeted_clean&quot;,</span>
<span class="c1">#     auto_open=True</span>
<span class="c1"># )</span>

<span class="c1">#</span>

<span class="c1"># -------------------------------------------------- Untargeted -----------------------------------------</span>
<span class="c1"># Applies above to multiple dataset results</span>
<span class="n">dataset_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># &quot;cpmg_db1__pca_reduction__bin005_overlap0025&quot;,</span>
    <span class="c1"># &quot;cpmg_db2__pca_reduction__bin005_overlap0025&quot;,</span>
    <span class="c1"># &quot;cpmg_db4__pca_reduction__bin005_overlap0025&quot;,</span>
    <span class="c1"># &quot;cpmg_db7__pca_reduction__bin005_overlap0025&quot;,</span>
    <span class="s2">&quot;cpmg_db20__pca_reduction__bin005_overlap0025&quot;</span><span class="p">,</span>
    <span class="c1"># &quot;cpmg_db38__pca_reduction__bin005_overlap0025&quot;,</span>
<span class="p">]</span>

<span class="n">extracted_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dataset_names</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset_names</span><span class="p">):</span>
    <span class="n">denoised_binned_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">__pca_reduction__bin005_overlap0025&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extracted_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">generate_plots</span><span class="p">(</span>
        <span class="n">datasets_root</span><span class="o">=</span><span class="s2">&quot;/Users/aw678/PycharmProjects/sequential_attention/sequential_attention/experiments/datasets/vasoplegia/different_wavelets&quot;</span><span class="p">,</span>
        <span class="n">denoised_dataset_name</span><span class="o">=</span><span class="n">extracted_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="c1"># computations_root=&quot;/Users/aw678/PycharmProjects/sequential_attention/sequential_attention/experiments/LOO_RFE_seq_attention_no_pre_wavelets_test/10_FOLDS_5_REPS/2023-07-27_12:00/{}/epoch500/no_scaler&quot;.format(denoised_binned_name),</span>
        <span class="n">computations_root</span><span class="o">=</span><span class="s2">&quot;/Users/aw678/PycharmProjects/sequential_attention/sequential_attention/experiments/LOO_RFE_seq_attention_CPMG_untargeted_db_test/10_FOLDS_10_REPS/2023-08-11_17:36/</span><span class="si">{}</span><span class="s2">/epoch800/auto_scaler&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">denoised_binned_name</span><span class="p">),</span>
        <span class="c1"># computations_root=&quot;/Users/aw678/PycharmProjects/sequential_attention/sequential_attention/experiments/LOO_RFE_seq_attention_CPMG_untargeted_db_test/10_FOLDS_10_REPS/2023-08-14_16:18/{}/epoch800/auto_scaler&quot;.format(denoised_binned_name),</span>
        <span class="c1"># computations_root=&quot;/Users/aw678/PycharmProjects/sequential_attention/sequential_attention/experiments/More_metrics/CPMG_untargeted/10_FOLDS_10_REPS/2023-08-18_18:07/{}/epoch800/auto_scaler&quot;.format(denoised_binned_name),</span>
        <span class="n">dataset_name</span><span class="o">=</span><span class="n">denoised_binned_name</span><span class="p">,</span>
        <span class="n">auto_open</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>


<span class="c1"># # Version without binning</span>
<span class="c1"># # Applies above to multiple dataset results</span>
<span class="c1"># dataset_names = [</span>
<span class="c1">#     &quot;cpmg_db1__pca_reduction__bin005_overlap0025&quot;,</span>
<span class="c1">#     &quot;cpmg_db4__pca_reduction__bin005_overlap0025&quot;,</span>
<span class="c1">#     &quot;cpmg_db7__pca_reduction__bin005_overlap0025&quot;,</span>
<span class="c1">#     &quot;cpmg_db20__pca_reduction__bin005_overlap0025&quot;,</span>
<span class="c1">#     &quot;cpmg_db38__pca_reduction__bin005_overlap0025&quot;,</span>
<span class="c1"># ]</span>
<span class="c1">#</span>
<span class="c1"># extracted_names = [name.split(&#39;__&#39;)[0] for name in dataset_names]</span>
<span class="c1">#</span>
<span class="c1"># for i, dn in enumerate(extracted_names):</span>
<span class="c1">#     # denoised_binned_name = &quot;{}__pca_reduction__bin005_overlap0025&quot;.format(extracted_names[i])</span>
<span class="c1">#     generate_plots(</span>
<span class="c1">#         datasets_root=&quot;/Users/aw678/PycharmProjects/sequential_attention/sequential_attention/experiments/datasets/vasoplegia/different_wavelets&quot;,</span>
<span class="c1">#         denoised_dataset_name=dn,</span>
<span class="c1">#         # computations_root=&quot;/Users/aw678/PycharmProjects/sequential_attention/sequential_attention/experiments/LOO_RFE_seq_attention_no_pre_wavelets_test/10_FOLDS_5_REPS/2023-07-27_12:00/{}/epoch500/no_scaler&quot;.format(denoised_binned_name),</span>
<span class="c1">#         computations_root=&quot;/Users/aw678/PycharmProjects/sequential_attention/sequential_attention/experiments/LOO_RFE_seq_attention_CPMG_untargeted_db_test/10_FOLDS_10_REPS/2023-08-11_17:36/{}/epoch800/auto_scaler&quot;.format(dn),</span>
<span class="c1">#         dataset_name=dn,</span>
<span class="c1">#         auto_open=True</span>
<span class="c1">#     )</span>

<span class="c1"># --------------------------------</span>
<span class="c1"># Version for targeted dataset</span>
<span class="c1"># -------------------------------</span>

<span class="c1"># epoch = [</span>
<span class="c1">#     # &quot;100&quot;, &quot;200&quot;, &quot;300&quot;, &quot;400&quot;, &quot;500&quot;,</span>
<span class="c1">#     &quot;800&quot;</span>
<span class="c1"># ]</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># for i, e in enumerate(epoch):</span>
<span class="c1">#     generate_plots(</span>
<span class="c1">#         datasets_root=&quot;/Users/aw678/PycharmProjects/sequential_attention/sequential_attention/experiments/datasets/vasoplegia&quot;,</span>
<span class="c1">#         denoised_dataset_name=&quot;CPMG_targeted_clean&quot;,</span>
<span class="c1">#         # computations_root=&quot;/Users/aw678/PycharmProjects/sequential_attention/sequential_attention/experiments/LOO_RFE_seq_attention_CPMG_untargeted_db_test/10_FOLDS_10_REPS/2023-08-11_17:36/{}/epoch800/auto_scaler&quot;.format(dn),</span>
<span class="c1">#         computations_root=&quot;/Users/aw678/PycharmProjects/sequential_attention/sequential_attention/experiments/More_metrics/CPMG_targeted_clean/10_FOLDS_10_REPS/2023-08-18_17:21/CPMG_targeted_clean/epoch{}/auto_scaler&quot;.format(e),</span>
<span class="c1">#         dataset_name=&quot;CPMG_targeted_clean&quot;,</span>
<span class="c1">#         auto_open=True</span>
<span class="c1">#     )</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">SpectraFlow</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">SpectraFlow</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Adrian Wesek.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>